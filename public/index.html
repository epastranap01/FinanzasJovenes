<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Jovenes | Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <script>
    // Verificar sesión
    fetch('/api/session')
    .then(res => res.json())
    .then(data => {
        if (!data.loggedIn) {
            window.location.href = '/login.html';
        } else if (data.user.rol === 'viewer') {
            // OCULTAR ELEMENTOS PARA LECTORES
            document.querySelector('.col-lg-4').style.display = 'none'; // Oculta el formulario
            document.querySelector('.col-lg-8').classList.replace('col-lg-8', 'col-lg-12'); // Expande la tabla
            
            // Inyectar CSS para ocultar la columna de acciones en la tabla
            const style = document.createElement('style');
            style.innerHTML = `
                .btn-icon, th:nth-child(6), td:nth-child(6) { display: none !important; }
            `;
            document.head.appendChild(style);
        }
    });
</script>
    <style>
        :root { --primary-color: #2c3e50; --bg-body: #f0f2f5; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: #333; }
        
        /* Navbar */
        .navbar { background: linear-gradient(135deg, #1e3c72 0%, #343941 100%); padding: 0.8rem 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Tarjetas */
        .kpi-card { border: none; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; padding: 1.5rem; }
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-value { font-size: 2rem; font-weight: 600; margin-bottom: 0; }
        
        .main-card { border: none; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .card-header-custom { padding: 1.2rem 1.5rem; font-weight: 600; color: var(--primary-color); border-bottom: 1px solid #f0f0f0; font-size: 1rem; }

        /* Formulario */
        .form-control, .form-select { border-radius: 8px; padding: 0.6rem 0.9rem; background-color: #f8fafc; border: 1px solid #e2e8f0; }
        .form-label { margin-bottom: 0.3rem; font-size: 0.85rem; font-weight: 500; color: #64748b; }
        .btn-custom { background-color: var(--primary-color); color: white; border-radius: 8px; padding: 0.7rem; font-weight: 500; width: 100%; transition: all 0.2s; }
        .btn-custom:hover { background-color: #1a252f; color: white; transform: scale(1.01); }
        
        .badge-custom { padding: 0.5em 0.8em; border-radius: 6px; font-weight: 500; font-size: 0.85rem; }
        .badge-ingreso { background-color: #d1e7dd; color: #0f5132; }
        .badge-egreso { background-color: #f8d7da; color: #842029; }
        
        /* Gráficos */
        .chart-container { position: relative; height: 220px; width: 100%; }
        .fade-in { animation: fadeIn 0.5s ease-in; }

        /* TABLA LIMPIA */
        .table-custom th { background-color: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 1rem; letter-spacing: 0.5px; }
        .table-custom td { padding: 1rem; vertical-align: middle; font-size: 0.9rem; }
        
        /* Botones de acción "Ghost" (Solo iconos) */
        .btn-icon { 
            border: none; 
            background: transparent; 
            padding: 0.3rem; 
            color: #94a3b8; 
            transition: all 0.2s;
            border-radius: 50%;
        }
        .btn-icon:hover { background-color: #f1f5f9; color: var(--primary-color); transform: scale(1.1); }
        .btn-icon.delete:hover { color: #dc3545; background-color: #fee2e2; }
        
        .row-highlight { background-color: #fff8e1 !important; transition: background 0.5s; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container">
        <span class="navbar-brand d-flex align-items-center gap-2">
            <i class="bi bi-wallet-fill"></i> <span>Finanzas Jóvenes</span>
        </span>
        <div class="d-flex align-items-center gap-3">
            <div class="text-white opacity-75 small d-none d-md-block"><i class="bi bi-person-circle"></i> Admin</div>
            <button onclick="logout()" class="btn btn-sm btn-outline-light rounded-pill px-3">Salir <i class="bi bi-box-arrow-right"></i></button>
        </div>
        <div class="text-white opacity-75 small"><i class="bi bi-calendar3"></i> Admin</div>
    </div>
</nav>

<div class="container pb-5">
    
    <div class="row g-4 mb-4 fade-in">
        <div class="col-md-4"><div class="kpi-card text-center border-bottom border-4 border-success"><div class="text-muted small mb-1 text-uppercase ls-1">Ingresos</div><div class="kpi-value text-success" id="totalIngresos">L 0.00</div></div></div>
        <div class="col-md-4"><div class="kpi-card text-center border-bottom border-4 border-danger"><div class="text-muted small mb-1 text-uppercase ls-1">Egresos</div><div class="kpi-value text-danger" id="totalEgresos">L 0.00</div></div></div>
        <div class="col-md-4"><div class="kpi-card text-center border-bottom border-4 border-primary bg-light"><div class="text-muted small mb-1 text-uppercase ls-1">Balance</div><div class="kpi-value text-primary" id="balanceTotal">L 0.00</div></div></div>
    </div>

    <div class="row g-4 mb-4 fade-in" style="animation-delay: 0.1s;">
        <div class="col-md-5"><div class="main-card p-4 h-100"><h6 class="text-muted mb-3 text-center small">Distribución</h6><div class="chart-container"><canvas id="chartBalance"></canvas></div></div></div>
        <div class="col-md-7"><div class="main-card p-4 h-100"><h6 class="text-muted mb-3 small">Gastos por Categoría</h6><div class="chart-container"><canvas id="chartGastos"></canvas></div></div></div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="main-card fade-in" style="position: sticky; top: 20px; z-index: 100;">
                <div class="card-header-custom d-flex justify-content-between align-items-center">
                    <span id="formTitle"><i class="bi bi-plus-circle-fill"></i> Nuevo Registro</span>
                    <button class="btn btn-sm btn-outline-secondary d-none" id="btnCancelEdit" onclick="cancelarEdicion()">Cancelar</button>
                </div>
                <div class="card-body p-4">
                    <form id="transaccionForm" class="row g-2">
                        <input type="hidden" id="editId" value="">
                        <div class="col-6"><label class="form-label">Tipo</label><select class="form-select" id="tipo" required><option value="Ingreso">Ingreso (+)</option><option value="Egreso">Egreso (-)</option></select></div>
                        <div class="col-6"><label class="form-label">Fecha</label><input type="date" class="form-control" id="fecha" required></div>
                        <div class="col-7"><label class="form-label">Categoría</label><select class="form-select" id="categoriaSelect" required><option value="">Cargando...</option></select></div>
                        <div class="col-5"><label class="form-label">Monto (L)</label><input type="number" step="0.01" class="form-control" id="monto" placeholder="0.00" required></div>
                        <div class="col-12"><label class="form-label">Detalle</label><textarea class="form-control" id="detalle" rows="2" placeholder="Descripción breve" required></textarea></div>
                        <div class="col-12 mt-4"><button type="submit" class="btn btn-custom shadow-sm" id="btnSubmit"><i class="bi bi-save2"></i> Guardar</button></div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="main-card fade-in h-100">
                <div class="card-header-custom d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-clock-history"></i> Historial Completo</span>
                    <button class="btn btn-sm btn-light border" onclick="loadData()"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-custom mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">Fecha</th>
                                    <th style="width: 80px;">Tipo</th>
                                    <th style="width: 15%;">Categoría</th>
                                    <th>Detalle</th>
                                    <th style="width: 110px;" class="text-end">Monto</th>
                                    <th style="width: 80px;" class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCuerpo"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = '/api';
    let chartInstanceBalance = null;
    let chartInstanceGastos = null;
    let allTransactions = [];

    const formatCurrency = (val) => new Intl.NumberFormat('es-HN', { style: 'currency', currency: 'HNL' }).format(val);
    const formatDateISO = (dateStr) => new Date(dateStr).toISOString().split('T')[0];
    const formatDateDisplay = (dateStr) => new Date(dateStr).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });

    async function loadCategorias() {
        try {
            const res = await fetch(`${API_URL}/categorias`);
            const categorias = await res.json();
            const select = document.getElementById('categoriaSelect');
            select.innerHTML = '<option value="">Seleccione...</option>';
            categorias.forEach(cat => select.innerHTML += `<option value="${cat.Id}">${cat.Nombre}</option>`);
        } catch (error) { console.error(error); }
    }

    async function loadData() {
        try {
            const resResumen = await fetch(`${API_URL}/resumen`);
            const dataResumen = await resResumen.json();
            document.getElementById('totalIngresos').innerText = formatCurrency(dataResumen.TotalIngresos);
            document.getElementById('totalEgresos').innerText = formatCurrency(dataResumen.TotalEgresos);
            document.getElementById('balanceTotal').innerText = formatCurrency(dataResumen.Balance);
            renderCharts(dataResumen.TotalIngresos, dataResumen.TotalEgresos);

            const resTrans = await fetch(`${API_URL}/transacciones`);
            allTransactions = await resTrans.json();
            
            const tbody = document.getElementById('tablaCuerpo');
            tbody.innerHTML = '';

            allTransactions.forEach(t => {
                const isIngreso = t.Tipo === 'Ingreso';
                const row = `
                    <tr id="row-${t.Id}">
                        <td class="text-muted fw-500 small">${formatDateDisplay(t.Fecha)}</td>
                        <td><span class="badge-custom ${isIngreso ? 'badge-ingreso' : 'badge-egreso'}">${t.Tipo}</span></td>
                        <td class="fw-bold text-secondary small">${t.CategoriaNombre || '---'}</td>
                        <td class="text-muted small text-truncate" style="max-width: 150px;">${t.Detalle}</td>
                        <td class="text-end fw-bold ${isIngreso ? 'text-success' : 'text-danger'}">
                            ${isIngreso ? '+' : '-'} ${formatCurrency(t.Monto)}
                        </td>
                        <td class="text-center">
                            <button class="btn-icon" title="Editar" onclick="cargarParaEditar(${t.Id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn-icon delete" title="Eliminar" onclick="eliminarRegistro(${t.Id})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        } catch (error) { console.error(error); }
    }

    // Funciones de Edición/Borrado (IGUAL QUE ANTES)
    function cargarParaEditar(id) {
        const t = allTransactions.find(x => x.Id === id);
        if (!t) return;
        document.getElementById('editId').value = t.Id;
        document.getElementById('fecha').value = formatDateISO(t.Fecha);
        document.getElementById('tipo').value = t.Tipo;
        document.getElementById('detalle').value = t.Detalle;
        document.getElementById('monto').value = t.Monto;
        
        // Intentar seleccionar la categoría automáticamente
        if(t.CategoriaId) document.getElementById('categoriaSelect').value = t.CategoriaId;

        document.getElementById('formTitle').innerHTML = '<i class="bi bi-pencil-square"></i> Editar';
        document.getElementById('btnSubmit').innerHTML = '<i class="bi bi-arrow-repeat"></i> Actualizar';
        document.getElementById('btnSubmit').classList.replace('btn-custom', 'btn-warning');
        document.getElementById('btnCancelEdit').classList.remove('d-none');
        
        document.querySelectorAll('tr').forEach(r => r.classList.remove('row-highlight'));
        document.getElementById(`row-${id}`).classList.add('row-highlight');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelarEdicion() {
        document.getElementById('transaccionForm').reset();
        document.getElementById('editId').value = '';
        document.getElementById('fecha').valueAsDate = new Date();
        document.getElementById('formTitle').innerHTML = '<i class="bi bi-plus-circle-fill"></i> Nuevo Registro';
        document.getElementById('btnSubmit').innerHTML = '<i class="bi bi-save2"></i> Guardar';
        document.getElementById('btnSubmit').classList.replace('btn-warning', 'btn-custom');
        document.getElementById('btnCancelEdit').classList.add('d-none');
        document.querySelectorAll('tr').forEach(r => r.classList.remove('row-highlight'));
    }

    async function eliminarRegistro(id) {
        const result = await Swal.fire({
            title: '¿Borrar?', text: "No se puede deshacer", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sí, borrar', cancelButtonText: 'Cancelar'
        });
        if (result.isConfirmed) {
            try {
                await fetch(`${API_URL}/transacciones/${id}`, { method: 'DELETE' });
                loadData();
                Swal.fire('Listo', 'Registro eliminado', 'success');
            } catch (e) { Swal.fire('Error', 'No se pudo borrar', 'error'); }
        }
    }

    document.getElementById('transaccionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const data = {
            fecha: document.getElementById('fecha').value,
            tipo: document.getElementById('tipo').value,
            categoriaId: document.getElementById('categoriaSelect').value,
            detalle: document.getElementById('detalle').value,
            monto: document.getElementById('monto').value
        };
        try {
            if (id) {
                await fetch(`${API_URL}/transacciones/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                Swal.fire({ icon: 'success', title: 'Actualizado', timer: 1500, showConfirmButton: false });
                cancelarEdicion();
            } else {
                await fetch(`${API_URL}/transacciones`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                Swal.fire({ icon: 'success', title: 'Guardado', timer: 1500, showConfirmButton: false });
                document.getElementById('transaccionForm').reset();
                document.getElementById('fecha').valueAsDate = new Date();
            }
            loadData();
        } catch (error) { console.error(error); }
    });

    async function renderCharts(ing, egr) {
        // Gráficos (Mismo código que ya funciona perfecto)
        const ctxB = document.getElementById('chartBalance').getContext('2d');
        if (chartInstanceBalance) chartInstanceBalance.destroy();
        chartInstanceBalance = new Chart(ctxB, { type: 'doughnut', data: { labels: ['Ingresos', 'Egresos'], datasets: [{ data: [ing, egr], backgroundColor: ['#198754', '#dc3545'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });

        const resG = await fetch(`${API_URL}/gastos-categoria`);
        const dataG = await resG.json();
        const ctxG = document.getElementById('chartGastos').getContext('2d');
        if (chartInstanceGastos) chartInstanceGastos.destroy();
        chartInstanceGastos = new Chart(ctxG, { type: 'bar', data: { labels: dataG.map(d => d.Categoria), datasets: [{ label: 'Lempiras', data: dataG.map(d => d.Total), backgroundColor: '#3498db', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } } });
    }

    document.getElementById('fecha').valueAsDate = new Date();
    loadCategorias();
    loadData();

    async function logout() {
    try {
        // Usamos ruta relativa para que funcione en Render
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = '/login.html';
    } catch (error) {
        console.error("Error al cerrar sesión:", error);
        window.location.href = '/login.html';
    }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>